---
layout: post
title: "О сериализации структур в json"
date: 2021-06-20 00:00:00
description: "Способы сериализации структур в json, и почему кодогенерация лучше всех"
---

Задача (де)сериализации структур в json решается тремя способами:

1. Проанализировать поля в рантайме с помощью рефлексии;
2. "Заранее" статически проанализировать структуры и нагенерировать для них
   кодеки;
3. Переложить все поля класса в json и обратно руками :)

В Scala по первому пути идёт, например, старая библиотека
[json4s](https://github.com/json4s/json4s). Но рантайм-рефлексия работает в
несколько раз медленнее заранее сгенерированного кода, а сериализация частенько
становится узким местом высоконагруженных приложений. Поэтому сообщество
сместилось в сторону второго подхода, который реализует библиотека
[circe](https://github.com/circe/circe).

Паттерн у генерации всяческих сериализаторов на Scala примерно одинаковый:
объявляется тайпкласс с дефолтными инстансами для примитивов (String, Int,
Boolean, etc...) и пользовательскими инстансами для своих типов. Для
кейс-классов макросом (или [встроенной
деривацией](https://github.com/circe/circe/blob/a49942e24d38e4505ffcc63429ba1dbb79bc448e/modules/core/shared/src/main/scala-3/io/circe/Derivation.scala)
в Scala 3) выводятся составные инстансы, в которых поля структуры
сопоставляются полю в json и конвертируются кодеком для типа поля.

{% highlight scala %}
trait Encoder[T] {
  def encode(obj: T): Json
}

implicit val stringEncoder: Encoder[String] =
  (str: String) => Json.fromString(str)

@JsonCodec case class Sample(stringValue: String)
{% endhighlight %}

Результирующий код в рантайме ведёт себя так же быстро как перекладывание
руками, но при этом кодек не нужно писать и поддерживать самостоятельно.

А вспомнил я об этом потому что наткнулся на библиотеку
[ffjson](https://github.com/pquerna/ffjson), которая решает те же проблемы в
голанге. Стандартный пакет использует рантайм-рефлексию, поэтому ffjson его
обгоняет. Только вместо макросов там кодеки просто кодогенерируются перед
сборкой проекта. Языки разные, а проблемы у всех одинаковые :)
