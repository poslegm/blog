---
layout: post
title: "Мучения от tapir"
date: 2021-06-20 00:00:00
description: "Мучения от tapir"
---

Ковырялся на работе с [тапиром](https://github.com/softwaremill/tapir), _не
понравилось_. tapir — это популярный в Scala-мире DSL для описания HTTP
эндпоинтов. DSL интерпретируется в "настоящие" эндпоинты на одном из четырёх
доступных веб-серверов и автоматически генерирует спецификацию в OpenAPI.
Собственно, ради автогенерации сваггера мы и затащили его в один REST-сервис.
Руками OpenAPI описывать всё-таки нудно и ненадёжно, а gRPC не подходил по
требованиям к сервису.

Основную боль причинила аутентификация: она дырявая и неудобная. Тапир сначала
парсит метод и путь запроса, а только потом проверяет наличие Auth-заголовка.
Значит злоумышленник может пореверс-инжинирить контракт, получая осмысленные
400 и 404 вместо 401. Если написать код аутентификации так, как предлагает в
[документация](https://tapir.softwaremill.com/en/latest/server/logic.html#defining-an-extendable-base-endpoint-with-partial-server-logic),
сервер ещё и тело запроса парсит :facepalm:. Уязвимость с телом я обошёл
[костылём](https://github.com/softwaremill/tapir/issues/1328), а вот чтобы
заткнуть дыру с парсингом пути, пришлось [кинуть
PR](https://github.com/softwaremill/tapir/pull/1329) (надеюсь, примут). Правда
код из документации всё равно останется дырявым by design, извольте писать
костыли.

Следующая боль — маппинг ошибок. Тапир заставляет маппить эксепшены в HTTP-коды
один к одному. При этом компиляторных гарантий полноты маппинга нет...
Естественно, всё многообразие ошибок бизнес-логики 1-к-1 на HTTP-коды не
замаппишь, поэтому приходится делать промежуточную ADT с сетевыми ошибками, а
уже её маппить в коды.

Но и такой маппинг нельзя красиво встроить в код эндпоинтов, потому что в
тапире нет абстракции для middleware! Поэтому всякие маппинги ошибок,
логирование и тд приходится вкорячивать либо непосредственно в веб-сервер (если
до него дойдёт всё, что хочется залогировать), либо костылить всратыми
адхоками.

Спасибо, Господи, за gRPC и GraphQL.
